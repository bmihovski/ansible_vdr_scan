---
# tasks file for vdr_install
- name: Install dependencies
  apt:
    name: '{{ item }}'
    update_cache: true
  with_items:
    - build-essential
    - libcap-dev
    - libfontconfig1-dev
    - gettext
    - libncursesw5-dev
    - libncurses5-dev
    - libmagick++-dev
    - libcxxtools-dev
    - dialog
    - dvb-apps
    - libdvbcsa-dev
    - libcrypto++-dev
    - libssl-dev
    - libsystemd-dev
    - python-pexpect

- name: Transfer DVB-S adapter firmware
  copy:
    src: files/firmware/dvb-demod-m88ds3103.fw
    dest: /lib/firmware
    
- name: Download DVB-C driver
  get_url:
    url: 'http://sundtek.de/media/sundtek_netinst.sh'
    dest: /tmp
    mode: 0775
    
- name: Install DVB-C driver
  expect:
   command: '/tmp/sundtek_netinst.sh'
   responses:
     Restriktionen verwendet werden: 'Y'
    
- name: Create VDR source dir
  file:
    path: '{{ vdr_target_src_dir }}'
    state: directory
    
- name: Download and extract latest VDR
  unarchive:
    src: 'ftp://ftp.tvdr.de/vdr/{{ vdr_ver }}.tar.bz2'
    dest: '{{ vdr_target_src_dir }}'
    remote_src: true
    
- name: Copy VDR compile conf
  copy:
    src: './files/vdr/compile/Make.config'
    dest: '{{ vdr_target_src_dir }}/{{ vdr_ver }}'
     
- name: Compile VDR
  make: 
    chdir: '{{ vdr_target_src_dir }}/{{ vdr_ver }}'
    params:
      NUM_THREADS: 3
  
- name: Clone VDR plugins
  git:
    dest: '{{ vdr_target_plugins_src }}/{{ item[0] }}'
    repo: '{{ item[1] }}'
  with_together:
    - [ 'restfulapi', 'dvbapi', 'streamdev' ]
    - [ 'https://github.com/yavdr/vdr-plugin-restfulapi.git', 'https://github.com/manio/vdr-plugin-dvbapi.git', 'git://projects.vdr-developer.org/vdr-plugin-streamdev.git' ]
    
- name: Compile VDR plugins
  make: 
    chdir: '{{ vdr_target_src_dir }}/{{ vdr_ver }}'
    target: install-plugins
    params:
      NUM_THREADS: 3
      LIBDVBCSA: 1

 
    
    